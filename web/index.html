<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lilypool</title>
    <style>
        html,
        body,
        #editor {
            margin: 0;
            height: 100%;
            font-family: "Helvetica Neue", Arial, sans-serif;
            color: #333;
        }

        textarea,
        #editor div {
            display: inline-block;
            width: 49%;
            height: 100%;
            vertical-align: top;
            box-sizing: border-box;
            padding: 0 5px;
        }

        textarea {
            border: none;
            border-right: 1px solid #ccc;
            resize: none;
            outline: none;
            background-color: #f6f6f6;
            font-size: 14px;
            font-family: "Monaco", courier, monospace;
            padding: 20px;
        }

        code {
            color: #f66;
        }
    </style>
</head>
<body>
<div id="editor">
    <textarea id="code"></textarea>
    <div>
        <canvas id="pdf"></canvas>
    </div>
</div>
<script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
<script
        src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
        crossorigin="anonymous"
></script>
<script>
    window.api = 'http://localhost:8080'
    const pdfjsLib = window['pdfjs-dist/build/pdf']
    const exampleCode = `
\\version "2.22.1"
{
% middle tie looks funny here:
<c' d'' b''>8. ~ <c' d'' b''>8
}
            `

    const run = function () {
        const $code = $('#code')
        $code.val(exampleCode)

        $.ajax({
            url: window.api,
            method: 'POST',
            data: {code: $code.val()},
            xhrFields: {responseType: 'arraybuffer'}
        }).done(function (data) {
            const loadingTask = pdfjsLib.getDocument({data})
            loadingTask.promise.then(function (pdf) {
                // console.log('PDF loaded')

                // Fetch the first page
                const pageNumber = 1
                pdf.getPage(pageNumber).then(function (page) {
                    // console.log('Page loaded')

                    const scale = 1
                    let viewport = page.getViewport({scale})

                    // Prepare canvas using PDF page dimensions
                    let canvas = document.getElementById('pdf')
                    let canvasContext = canvas.getContext('2d')
                    canvas.height = viewport.height
                    canvas.width = viewport.width

                    // Render PDF page into canvas context
                    const renderTask = page.render({canvasContext, viewport})
                    renderTask.promise.then(function () {
                        console.log('Page rendered')
                    })
                })
            }, function (reason) {
                // PDF loading error
                console.error(reason)
            })
        }).fail(function (err) {
            console.err(err)
        })
    }

    $(document).ready(run())
</script>
<script src="/js/index.js"></script>
</body>
</html>
